
ext.integrationTasks = []

def runIntegrationTest(String taskName, List<String> argList) {
    def appModule = ":contract-chameleon.cl"
    tasks.register(taskName, JavaExec) {
        group = "application"
        description = "Run task '${taskName}'"
        dependsOn "${appModule}:classes"

        def sub = project(appModule)
        classpath = sub.sourceSets.main.runtimeClasspath
        mainClass.set(sub.application.mainClass)

        args = argList
    }
    ext.integrationTasks << taskName
}

// - Integration test specifications

// VeriFast export

runIntegrationTest("vf-applicant", ["verifast-applicant", "./export/examples/counter.clib"])
runIntegrationTest("vf-provider", ["verifast-provider", "./export/examples/counter.clib"])

runIntegrationTest("vf-applicant-core", ["verifast-applicant", "./export/theories/Core.clib"])
runIntegrationTest("vf-provider-core", ["verifast-provider", "./export/theories/Core.clib"])

runIntegrationTest("vf-applicant-ref", ["verifast-applicant", "./export/theories/Ref.clib"])
runIntegrationTest("vf-provider-ref", ["verifast-provider", "./export/theories/Ref.clib"])

runIntegrationTest("vf-applicant-seq", ["verifast-applicant", "./export/theories/Seq.clib"])
runIntegrationTest("vf-provider-seq", ["verifast-provider", "./export/theories/Seq.clib"])

runIntegrationTest("vf-applicant-set", ["verifast-applicant", "./export/theories/FiniteSet.clib"])
runIntegrationTest("vf-provider-set", ["verifast-provider", "./export/theories/FiniteSet.clib"])

runIntegrationTest("vf-applicant-map", ["verifast-applicant", "./export/theories/FiniteMap.clib"])
runIntegrationTest("vf-provider-map", ["verifast-provider", "./export/theories/FiniteMap.clib"])

runIntegrationTest("vf-applicant-adt", ["verifast-applicant", "./export/theories/AlgebraicDataTypes.clib"])
runIntegrationTest("vf-provider-adt", ["verifast-provider", "./export/theories/AlgebraicDataTypes.clib"])


// KeY export

runIntegrationTest("key-applicant", ["key-applicant", "./export/examples/counter.clib"])
runIntegrationTest("key-provider", ["key-provider", "./export/examples/counter.clib"])

runIntegrationTest("key-applicant-core", ["key-applicant", "./export/theories/Core.clib"])
runIntegrationTest("key-provider-core", ["key-provider", "./export/theories/Core.clib"])

runIntegrationTest("key-applicant-ref", ["key-applicant", "./export/theories/Ref.clib"])
runIntegrationTest("key-provider-ref", ["key-provider", "./export/theories/Ref.clib"])

runIntegrationTest("key-applicant-seq", ["key-applicant", "./export/theories/Seq.clib"])
runIntegrationTest("key-provider-seq", ["key-provider", "./export/theories/Seq.clib"])

runIntegrationTest("key-applicant-set", ["key-applicant", "./export/theories/FiniteSet.clib"])
runIntegrationTest("key-provider-set", ["key-provider", "./export/theories/FiniteSet.clib"])

runIntegrationTest("key-applicant-map", ["key-applicant", "./export/theories/FiniteMap.clib"])
runIntegrationTest("key-provider-map", ["key-provider", "./export/theories/FiniteMap.clib"])

runIntegrationTest("key-applicant-adt", ["key-applicant", "./export/theories/AlgebraicDataTypes.clib"])
runIntegrationTest("key-provider-adt", ["key-provider", "./export/theories/AlgebraicDataTypes.clib"])


// KeY Import

// Check importability of files:
/*
 * ```sh
 * cd tools/
 * ```
 *
 * ```sh
 * java -cp ci-tool.jar:key-2.12.3-exe.jar \
 *    io.github.wadoon.keycitool.CheckerKt \
 *    ../_Contract-Chameleon/tests.integration/import/examples/_counter/
 * ```
 *
 * ```sh
 * java -cp ci-tool.jar:key-2.12.3-exe.jar \
 *    io.github.wadoon.keycitool.CheckerKt \
 *    ../_Contract-Chameleon/tests.integration/import/examples/_stack/
 * ```
 */

runIntegrationTest("key-import-examples-counter", ["key-import", "./import-from-key/examples/_counter/"])
runIntegrationTest("key-import-examples-stack", ["key-import", "./import-from-key/examples/_stack/"])

runIntegrationTest("key-import-features", ["key-import", "./import-from-key/features/"])
runIntegrationTest("key-import-theories", ["key-import", "./import-from-key/theories/"])



// - Job for all integration tests joined

tasks.register('run-integration-tests') {
    group = "application"
    description = "Run all integration tests"
    //dependsOn("vf-applicant", "vf-provider", "key-applicant", "key-provider")
    dependsOn integrationTasks
}

// - Check that the tools for the integration tests exist
//   - KeY
//   - CI for KeY
//   - VeriFast

tasks.register('check-tools-files') {

  println "Root dir: ${rootProject.rootDir}"
  println "Project dir: ${project.projectDir}"
  println "----"

  def key = project.findProperty("custom_key_exe") ?: contract_chameleon_key_exe
  def ci_key = project.findProperty("custom_key_exe") ?: contract_chameleon_ci_key_exe
  def verifast = project.findProperty("custom_verifast_exe") ?: contract_chameleon_verifast_exe

  println "Default KeY executable: $contract_chameleon_key_exe"
  println "Default VeriFast executable: $contract_chameleon_verifast_exe"
  println "Default CI Tool executable: $contract_chameleon_ci_key_exe"

  println "Using $key"
  println "Using $ci_key"
  println "Using $verifast"

  println "----"

  def key_file = new File(rootProject.rootDir, key)
  def ci_key_file = new File(rootProject.rootDir, ci_key)
  def verifast_file = new File(rootProject.rootDir, verifast)

  println key_file.exists() ? "✅ KeY exists: ${key_file.absolutePath}" : "❌ KeY not found: ${key_file.absolutePath}"
  println ci_key_file.exists() ? "✅ KeY CI exists: ${ci_key_file.absolutePath}" : "❌ KeY CI not found: ${ci_key_file.absolutePath}"
  println verifast_file.exists() ? "✅ VeriFast exists: ${verifast_file.absolutePath}" : "❌ VeriFast not found: ${verifast_file.absolutePath}"
}

tasks.register("run-help-verifast", Exec) {
  def verifast = project.findProperty("custom_verifast_exe") ?: contract_chameleon_verifast_exe
  def verifast_file = new File(rootProject.rootDir, verifast)

  commandLine verifast_file.absolutePath, "--help"

  dependsOn 'check-tools-files'
}

tasks.register("run-help-key-ci", Exec) {
  def key = project.findProperty("custom_key_exe") ?: contract_chameleon_key_exe
  def ci_key = project.findProperty("custom_key_exe") ?: contract_chameleon_ci_key_exe
  def key_file = new File(rootProject.rootDir, key)
  def ci_key_file = new File(rootProject.rootDir, ci_key)

  commandLine "java", "-cp", "$ci_key_file:$key_file", "io.github.wadoon.keycitool.CheckerKt", "--help"

  dependsOn 'check-tools-files'
}

tasks.register("run-help-key", Exec) {

  def key = project.findProperty("custom_key_exe") ?: contract_chameleon_key_exe
  def key_file = new File(rootProject.rootDir, key)

  commandLine "java", "-jar", key_file.absolutePath, "--help"
  ignoreExitValue = true

  dependsOn 'check-tools-files'
}

tasks.register("run-help-all") {
    dependsOn 'run-help-key', 'run-help-key-ci', 'run-help-verifast'
}

// - Check the input for the tests

ext.key_ci_tests = []

def check_key_files(String taskName, String path_to_files) {
  tasks.register(taskName, Exec) {
    group = "KeY CI"
    def key = project.findProperty("custom_key_exe") ?: contract_chameleon_key_exe
    def ci_key = project.findProperty("custom_key_exe") ?: contract_chameleon_ci_key_exe
    def key_file = new File(rootProject.rootDir, key)
    def ci_key_file = new File(rootProject.rootDir, ci_key)
    //If this fails, it would be goood to create the $buildDir direcory manually
    def statistic_file = "$buildDir/$taskName-statistic.json"

    commandLine "java", "-cp", "$ci_key_file:$key_file", "io.github.wadoon.keycitool.CheckerKt", path_to_files, "-s", statistic_file
  }
  ext.key_ci_tests << taskName
}

// Check all key projects specified in "key_ci_files.txt"

def key_ci_files = file("key_ci_files.txt")
if (key_ci_files.exists()) {
  println "KeY CI not given!"
  def key_ci_lines = key_ci_files.readLines()

  key_ci_lines.each { line -> 
    def taskName = "key_ci-check-" + line.replace("/", "_")
    println "KeY check task: $taskName"
    check_key_files(taskName, line)
  }
} 

tasks.register("key_ci-check-all") {
  group = "KeY CI"
  dependsOn key_ci_tests
}




